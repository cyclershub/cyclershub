---
import Layout from "../../layouts/Layout.astro";
import Preview from "../../components/Gallery/Preview.svelte";
import { db } from "~/lib/shared";
import { isLoggedIn } from "~/lib/SharedVerification";
import Plus from "~/components/Icons/Plus.svelte";

const loggedIn = await isLoggedIn(Astro);

const entries = await db("setups").select("*").orderBy("setups.created_on", "desc").limit(6);

// For each entry, select all images and add them to the entry
for (const entry of entries) {
	const images = await db("setups_images").select("images.*").leftJoin("images", "setups_images.images_id", "images.id").where("setups_images.setups_id", entry.id);
	entry.images = images;

	if (images.length > 0) {
		entry.cover = `/api/image/${images[0].uid}.png`;
	}

	// Get the author name
	const author = await db("users").select("users.username").where("users.id", entry.users_id).first();
	entry.author = author.username;
}

---

<Layout title="Gallery | CyclersHub">
	<div class="flex flex-row justify-between items-center">
		<h1>Gallery</h1>
		{loggedIn ? <a href="/gallery/new"><Plus width={35} height={35} class="fill-black-brown"></Plus></a> : null}
	</div>
	<div class="columns-3 gap-8 [&>*]:mb-8">
		{entries.map(entry => (
			<Preview entry={entry} href={`/gallery/${entry.uid}`} />
		))}
	</div>
</Layout>
